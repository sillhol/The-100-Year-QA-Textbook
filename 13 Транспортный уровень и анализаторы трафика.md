# 13 Транспортный уровень и анализаторы трафика
## Транспортный уровень модели TCP/IP
Суть транспортного уровня - в определении способов передачи данных, то есть в определении, как именно данные будут передаваться
### Основные принципы и понятия
#### Сетевые пакеты
+ нельзя передать большой файл за раз одной порцией. Он разделяется на пакет, которые на принимающей стороне снова собираются в файл и передаются приложениям
+ Максимальный размер пакета зависит от настроек канального уровня, в современных сетях он обычно равен 1500 байтов
+ Когда вы запрашиваете файл или веб-страницу, обычно ваш запрос помещается в один пакет, 
+ Ответ сервера превышает размер пакета, поэтому он разделяется на части, которые доставляются приложению вашего клиента.
#### Сетевые порты
Порты используются как протоколом TCP, так и протоколом UDP

+ При запуске сетевое серверное приложение (например, веб-сервер) открывает порт и начинает прослушивать его.
  + Представьте, что у аппаратного сервера есть IP-адрес 1.2.3.4 и приложение веб-сервера прослушивает порт 80.
  + Одновременно на этом же аппаратном сервере может работать приложение сервера электронной почты, использующее порт 25 для принятия входящих запросов.
  + Это означает, что если клиент хочет получить веб-страницу, то он должен отправить запрос на порт 80, но если он хочет отправить электронное письмо, то он должен направить его на порт 25.
+ Когда клиент обменивается данными с сервером, порт также открыт и на стороне клиента; этот порт используется приложением клиента, для взаимодействия с удалённым сервером.
  + Каждое соединение будет представлено уникальным кортежем значений: {transport_protocol, client_IP, client_port, server_IP, server_port} (транспортный_протокол, IP_клиента, порт_клиента, IP_сервера, порт_сервера). Это позволяет операционной системе (ОС) клиента различать соединения разных программ, обменивающихся данными с разными удалёнными серверами.
  + Итак, узел клиента работает с несколькими серверами одновременно.
  + Более того, один и тот же узел клиента может работать с одним и тем же приложением сервера (например, 1.2.3.4:80), используя одновременно несколько приложений (например, вы можете запрашивать страницы одного и того же веб-сайта с помощью браузеров Firefox, Safari, Chrome, Opera), — для каждого соединения будет использоваться свой порт клиента, поэтому потоки данных не перепутаются.

TCP и UDP
Прослушиваемые порты TCP и UDP:
ОС Linux: netstat -vpntul или ss -pntul
macOS: netstat -anf inet | egrep -v 'EST|WAIT' | sort | uniq
Windows: netstat
Активные порты TCP и UDP (ESTABLISHED):
ОС Linux: netstat -vpntu
macOS: netstat -anf inet | egrep EST
Windows: netstat -a
***--
/etc/services - порты, соотнесённые с сетевыми приложениями

************************************************************
Анализаторы сетевого трафика «снифферы»
************************************************************
tcpdump:
tcpdump <options> <expression>
Опции для сбора пакетов:
-c <N>
-i <interface_name>: -i lo, -i any
-s <N>: -s 0, -s60
-w <file>
-r <file>
Опции для отображения:
-n
-nn
-X
-A
-ttt
-v / -vv / -vvv
Выражения (фильтры):
host X: host example.com, host 8.8.8.8
net X/Y: net 8.8.0.0/16
port X: "tcp and (port 22 or port 3389)", port 53
tcp / udp / icmp: tcp and port 8080, udp and not port 53, icmp
src: tcp and src host 192.168.40.150 and src port 22
dst: udp and dst host 8.8.8.8 and dst port 53
portrange X-Y: tcp and src portrange 1-1023

Wireshark

