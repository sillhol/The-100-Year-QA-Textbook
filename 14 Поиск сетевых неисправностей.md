# 14 Поиск сетевых неисправностей
## Проблемы, возможные на сетевом уровне
### ICMP — Internet Control Message Protocol
**ICMP** - протокол транспортного уровня но, с его помощью приложения не передают какие-либо данные. Единственное, для чего он служит, это пересылка сообщений о состоянии узлов и сетевых проблемах от одного узла к другому.
![Структура пакета ICMP](resources/ts_1.png), где:
+ Type (Тип) - поле, определяющее тип сообщения ICMP, например, ошибки в сети, запросы эха (ping) и другие управляющие сообщения.
  + "Echo Request"(Эхо-запрос) (Type=8) и “Echo Reply” (Type=0). Эти типы используются утилитой ping, а также программой traceroute в режиме ICMP
  + "Destination Unreachable" (Type=3) - используя этот тип сообщения, шлюзы уведомляют, что они не могут достичь узла назначения текущего IP-пакета.
  + "Time Exceeded" (Type=11). Если на шлюз пришел пакетом с нулевым полем TTL в заголовке IP (Time to live — время существования, то есть количество промежуточных узлов, до исчерпания которого пакет существует в сети, а затем отбрасывается маршрутизатором), то он пошлёт отправителю сообщение «Время истекло». Именно на основе этого принципа работает утилита traceroute
+ Code (Код) - дополнительное поле, которое дополняет тип сообщения и может уточнять его. Например, для сообщений об ошибке этот код может указывать на конкретный тип ошибки.
  + "Destination port unreachable" (Code=3) добавляется в некоторых случаях удалённым узел в ответ на попытку подключения по протоколу UDP к закрытому порту в дополнение к "Destination Unreachable" (Type=3) (так как у самого UDP нет способа реакции на такое событие)
  + "Time to live exceeded in transit" (Code=0) при Time Exceeded (Type=11) обычно используется для указания причины превышения времени
+ Checksum (Контрольная сумма): Это поле содержит контрольную сумму заголовка ICMP-сообщения, помогая обнаруживать ошибки в передаче данных.
+ Content (Содержание) - содержимое самого сообщения ICMP, которое может варьироваться в зависимости от его типа и кода. Например, для сообщений об ошибках содержание может включать дополнительную информацию о характере ошибки, а для запросов эха - данные для проверки доступности хоста.

*ICMP не предполагает использование портов.*
### ping
#### Функции 
+ Проверка достижимости удалённого узла.
+ Измерение суммарного времени, потраченного на передачу и подтверждение пакета (параметр RTT, round-trip time). Высокие значения RTT указывают на высокую задержку, что может повлиять на производительность сетевых приложений. Постоянно высокие или резко изменяющиеся значения RTT могут свидетельствовать о проблемах со стабильностью сети, таких как нестабильные маршруты или перегруженные сетевые устройства

#### Принцип работы
1. Удалённому узлу отправляется эхо-запрос протокола ICMP ```ping [options] <remote_host>```;
2. Если удалённый узел настроен надлежащим образом, то он отправит пакет с “Echo Reply” (Type=0) протокола ICMP

#### Полезные опции ping для ОС Linux и macOS
+ ```-c <N>```: остановиться после N пакетов
+ ```-s <N>```: отправлять пакеты размером N байт. Отправка очень больших пакетов (например, 65000 байт) может использоваться для тестирования, но также может вызвать проблемы, такие как фрагментация пакетов, нагрузка на сеть или на целевой узел, что может привести к потерям пакетов или другим проблемам. Многие сети и устройства могут блокировать или ограничивать размер пакетов, чтобы предотвратить атаки и перегрузки. Такие большие пакеты могут быть отброшены или ограничены
+ ```-t <N>```: установить значение поля TTL IP-пакета в N. Установив -t 1 можно получить IP-адрес шлюза, используемого по умолчанию, т.к. при значении TTL = 1 пакет будет отброшен ближайшим промежуточным узлом (то есть вашим шлюзом, используемым по умолчанию) с отправкой сообщения «Время истекло»
+ ```-A```: включает адаптивный режим, который автоматически завершает команду ping, если ответы становятся стабильными. Это может помочь предотвратить бесконечный пинг, если узел стабильно отвечает на запросы.

#### Примеры
+ ```ping example.com```
+ ```ping -c 10 example.com``` (по умолчанию ```ping``` работает до нажатия клавиш Ctrl+C)
+ ```sudo ping -A -s 65000 192.168.100.1```
+ ```ping -t 1 example.com```

*вывод ping:*
```console
[user@host]$ ping -c 3 example.com
PING example.com (93.184.216.34): 56 data bytes
64 bytes from 93.184.216.34: icmp_seq=0 ttl=50 time=129.329 ms
64 bytes from 93.184.216.34: icmp_seq=1 ttl=50 time=128.532 ms
64 bytes from 93.184.216.34: icmp_seq=2 ttl=50 time=128.729 ms


--- example.com ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 128.532/128.863/129.329/0.339 ms
```
#### ВАЖНО
1. ```ping``` **не измеряет пропускную способность соединения (bandwitch)**. Могут быть соединения с низкой задержкой (т. е. параметром RTT) и одновременно с низкой пропускной способностью («скоростью»), а также с высоким RTT и высокой пропускной способностью.
2. ```ping``` **нельзя использовать для проверки доступности удалённого ПОРТА**. Это распространённая ошибка новичков: на вопрос «как вы будете проверять, открыт удалённый порт или нет?», некоторые отвечают «я буду использовать ping». В протоколе ICMP нет портов, и он не относится к протоколам TCP и UDP, поэтому его нельзя применить для такой проверки. Вместо этого используйте программы nc или nmap (о них поговорим позже).
3. **Протокол ICMP может быть заблокирован в настройках межсетевых экранов или серверов**. По этой причине не будет эхо-ответа даже от доступных корректно работающих узлов. Отсутствие эхо-ответа от удалённого узла может означать всего лишь работу межсетевого экрана.
4. Значения TTL в выводе ping — работающий способ приблизительно определить тип ОС удалённого узла
### traceroute
**traceroute** — это сетевая утилита, используемая для определения маршрута, по которому пакеты проходят от исходного хоста до целевого хоста в IP-сети. Она помогает диагностировать проблемы с сетью, показывая последовательность маршрутизаторов (или "хопов"), через которые проходят пакеты. Это позволяет выявить узкие места, задержки или точки отказа в сети.
```traceroute опции адрес_узла```

Алгоритм работы ```traceroute```: программа отправляет пакеты с TTL = 1, TTL = 2…, пока не достигнет удалённого узла и не получит ожидаемый ответ. Все промежуточные узлы отклоняют пакеты, когда параметр TTL достигает нуля, а в каждом ответе этих узлов содержится их IP-адрес.
#### Функции
+ показывает все промежуточные узлы (маршрутизаторы), через которые проходят пакеты до достижения целевого хоста.
+ показывает время обратного хода (RTT) для каждого хопа, что позволяет оценить задержку на каждом этапе маршрута
+ помогает определить, на каком участке сети возникают задержки или потери пакетов
#### Опции
1. ```-U``` - В UNIX (Linux, macOS) ```traceroute``` по умолчанию применяет пакеты UDP (```traceroute -n yandex.ru``` = ```traceroute -n -U yandex.ru```), отправляемыми вовне на случайные порты серверов. Поэтому он часто блокируется межсетевыми экранами, и ```traceroute``` в таком случае не покажет некоторые промежуточные узлы, расположенные между вами и удалёнными узлами (```traceroute -n -U yandex.ru```).
2. ```-T``` - ```traceroute``` поддерживает протокол TCP. В Этом случае будут отправляться пакеты с флагом SYN
3. ```-I``` - использовать ICMP пакеты вместо UDP;
4. ```-p``` - указать порт вместо порта по умолчанию;
5. ```-g``` - передавать пакет через указанный шлюз;
6. ```-i``` - передавать пакет через указанный интерфейс;
7. ```-P``` - протокол, доступны такие значения: raw, dccp, udplite, udp, tcpconn, tcp, icmp

*Алгоритм работы ```traceroute``` не зависит от используемого протокола*

*Аналог ```traceroute``` в Windows (```tracert```) по умолчанию применяет протокол ICMP*
#### Примеры
+ ```traceroute -n yandex.ru```
+ ```traceroute -nI yandex.ru```
+ ```traceroute -nT yandex.ru```
+ ```traceroute -nU yandex.ru``` = ```traceroute -n yandex.ru```
### Проблемы с маршрутизацией и узлами, отключенными от сети
<!-- HTML для объединения ячеек -->
<table>
  <thead>
    <tr>
      <th>Текст ICMP-сообщения</th>
      <th>Причины</th>
    </tr>
  </thead>
  <tbody>
    <tr>
	  <td rowspan="3">"No route to host"</td>
	  <td>Это сообщение указывает на проблему с маршрутизацией пакетов в сети. Оно возникает, когда операционная система или маршрутизатор не может найти маршрут для доставки пакета к указанному хосту. Причины:</td>
    </tr>
     <tr>
      <td>- нет ни одного правила в вашей таблице маршрутизации</td>
    </tr>
    <tr>
      <td>- в настройках узла не указан маршрутизатор, используемый по умолчанию</td>
    </tr>
    <tr>
      <td rowspan="4">"Destination host unreachable"</td>
      <td>Это сообщение генерируется маршрутизатором или шлюзом, когда он не может найти путь к целевому хосту, несмотря на наличие маршрута к сети этого хоста. Причины:</td>
    <tr>
      <td>- у маршрутизатора нет маршрута к заданной подсети</td>
    </tr>
    </tr>
    <tr>
      <td>- узел назначения не в сети</td>
    </tr>
    <tr>
      <td>- протокол ICMP отключён на промежуточных межсетевых экранах или узле назначения</td>
    </tr>
  </tbody>
</table>

При необходимости проверить доступность узла и при полном отключении на промежуточных межсетевых экранах или на самом узле назначения протокола ICMP  (т.к. ```ping``` возвращает «Destination host unreachable») достаточно удалённо проверить TCP или UDP порты узла с помощью:
+ ```nc -vz адрес_узла №_порта```
+ ```traceroute -U -p 25 mx1.ptsecurity.com``` (однако, важно понимать, что traceroute и nc (netcat) имеют разные цели. nc проверяет доступность конкретного порта на целевом узле, пытаясь установить соединение, в то время как traceroute показывает маршрут пакетов и может использоваться для диагностики проблем с сетевой связью на каждом шаге маршрута)
### Проблемы с системой DNS
<table>
	<thead>
		<tr>
			<th>Текст ICMP-сообщения</th>
			<th>Причины</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td rowspan="5">"Name or service not known"</td>
			<td>Это сообщение обычно генерируется утилитами, которые пытаются разрешить имя хоста в IP-адрес, когда DNS (Domain Name System) не может найти указанный домен. Причины:</td>
		</tr>
		<tr>
			<td>- узел не существует</td>
		</tr>
		<tr>
			<td>- доменное имя существует, но у него нет IP-адреса (доменное имя зарегистрировали, но при не настроили доменную зону). Чтобы определить существование доменного имени можно использовать инструмент командной строки <code>whois</code> в ОС Linux /</td>
		</tr>
		<tr>
			<td>- на клиентском узле ошибка в настройке «DNS-резолвера» (следует проверить /etc/resolv.conf)</td>
		</tr>
		<tr>
			<td>- не работает «резолвер» (проверить можно с помощью публичных «резолверов»: <code>host badhostname.com 8.8.8.8</code> или <code>dig badhostname.com @8.8.8.8</code>)</td>
		</tr>
	</tbody>
</table>

*DNS-резолвер (или DNS-клиент) — это компонент программного или аппаратного обеспечения, отвечающий за выполнение DNS-запросов. Его основная задача — преобразование человекочитаемых доменных имен в соответствующие IP-адреса и наоборот*
### Потеря пакетов:
перегрузка интерфейса одного из узлов (включая шлюзы), проблемы с физическим каналом.
как проверить:
1. ping удалённый_узел -s 1 (пакеты размером примерно 1 КБ). Если > 5 % потерь => потеря пакетов
2. Создайте файл PCAP с образцом потока пакетов между клиентом и удалёнными узлами, используя tcpdump с фильтрами для узлов и портов. Если есть такая возможность, выполните то же самое на узле назначения. Откройте сохранённый файл в программе Wireshark и поищите красные и (или) чёрные метки.
----------------------------
Проблемы транспортного уровня
Открытые и закрытые порты:
	nc, nmap - удалённая проверка
	netstat, ss - локальная проверка (при наличии непосредственного доступа к интересующему узлу или по протоколу SSH)
	lsof

	1. Порт открыт и доступен.
	2. Порт закрыт, т. е. ни одно из приложений сервера не прослушивает этот порт.
	3. У нас истекло время ожидания, поскольку, например, порт защищен межсетевым экраном, или узел не в сети, или узел недостижим.

	nc:		nc -vz server_address port - Проверить только один порт
			nc -z server_address 1000-2000 - проверить диапазон портов
			time nc -vz server_address port - команда time измеряет время выполнения программы (здесь - nc)
			-	"-v" для получения подробного вывода (т.е. будут показаны и неудачные попытки)
			-	"-z" для проверки доступности порта			
			
			nc должным образом не работает с портами UDP
		
	nmap:	сетевой сканер (самый известный)
		nmap -sT -pA-B адрес_узла 		- с установкой соединения TCP посредством «рукопожатия»
		sudo nmap -sS pA-B адрес_узла	- тоже, но быстрее (посредством отправки пакетов TCP SYN, без установки соединения)
		sudo nmap -sU pA-B адрес_узла	- сканирования портов UDP; операция намного медленнее даже чем режим с опцией -sT
		nmap -sP адрес_сети/маска		- поиск доступных в сети узлов,-sP сканирование ping-ом (хотя в локальных сетях вместо этого применяется протокол ARP)
		nmap -Pn -sT -p22,9099,10000 адрес_узла - сканирование списка портов заданного узла
		
		состояния просканированных портов:
		open - доступен для клиентов, не заблокирован межсетевым экраном, прослушивается неким приложением на серверной стороне;
		closed - доступен для клиентов и не заблокирован межсетевым экраном, не прослушивается ни одним приложением;
		filtered - заблокирован межсетевым экраном, все пакеты, отправленные на этот порт, были отброшены; неизвестно, прослушивается ли этот порт каким-либо приложением.
		
	Connection refused (попытка соединения с закрытым портом ):	
		- остановка сетевого приложения на удаленном сервере, которое должно было прослушивать порт назначения
		- указание неверного порта
		- межсетевой экрана
	Connection timeout (попытка соединиться с недоступным удалённым узлом)
		- отсутствие ответа на ваш пакет SYN
		- блокирование порта назначения со стороны межсетевого экрана
Конфликты портов:
	- Address already in use: nc -l 15672 - попытка запустить nc в режиме сервера, прослушивающего TCP порт (здесь 15672)
	- Permission denied
		- попытка открыть TCP порт < 1024: nc -l 1023
		- попытка открыть UDP порт < 1024:nc -u -l 1023

